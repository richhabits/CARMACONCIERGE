// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  role      UserRole @default(CUSTOMER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vehicles        Vehicle[]
  jobs            Job[]
  sentMessages    Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  payments        Payment[]

  @@map("users")
}

enum UserRole {
  CUSTOMER
  ADMIN
  SUPPLIER
}

model Vehicle {
  id           String   @id @default(uuid())
  userId       String
  make         String
  model        String
  year         Int
  registration String   @unique
  vin          String?
  mileage      Int?
  color        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobs Job[]

  @@map("vehicles")
}

model Job {
  id            String     @id @default(uuid())
  vehicleId     String
  userId        String
  type          JobType
  status        JobStatus  @default(PENDING)
  description   String
  scheduledDate DateTime?
  completedDate DateTime?
  cost          Float?
  supplierId    String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  vehicle  Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  supplier Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  quotes   Quote[]
  messages Message[]
  payments Payment[]

  @@map("jobs")
}

enum JobType {
  MOT
  SERVICE
  REPAIR
  INSPECTION
}

enum JobStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Quote {
  id          String      @id @default(uuid())
  jobId       String
  supplierId  String
  amount      Float
  description String
  validUntil  DateTime
  status      QuoteStatus @default(PENDING)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  job      Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@map("quotes")
}

enum QuoteStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

model Supplier {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  phone     String
  address   String
  city      String
  postcode  String
  rating    Float?
  verified  Boolean  @default(false)
  services  String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobs   Job[]
  quotes Quote[]

  @@map("suppliers")
}

model Message {
  id         String   @id @default(uuid())
  senderId   String
  receiverId String
  jobId      String?
  content    String
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  sender   User  @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User  @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  job      Job?  @relation(fields: [jobId], references: [id], onDelete: SetNull)

  @@map("messages")
}

model Payment {
  id            String        @id @default(uuid())
  userId        String
  jobId         String
  amount        Float
  currency      String        @default("GBP")
  status        PaymentStatus @default(PENDING)
  paymentMethod PaymentMethod
  transactionId String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@map("payments")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  BANK_TRANSFER
  WALLET
}
