// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  SUPPLIER
  ADMIN
  FLEET_MANAGER
}

enum AuthProvider {
  EMAIL
  GOOGLE
  APPLE
}

enum VehicleType {
  CAR
  VAN
  MOTORCYCLE
  TRUCK
  OTHER
}

enum FuelType {
  PETROL
  DIESEL
  ELECTRIC
  HYBRID
  OTHER
}

enum JobType {
  MOT
  SERVICING
  REPAIR
  INSPECTION
  OTHER
}

enum JobStatus {
  PENDING
  QUOTED
  APPROVED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum SupplierType {
  GARAGE
  MOBILE_MECHANIC
  DEALERSHIP
  SPECIALIST
}

enum QuoteStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  BANK_TRANSFER
  PAYPAL
  APPLE_PAY
  GOOGLE_PAY
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole @default(CUSTOMER)
  phone     String?
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  vehicles    Vehicle[]
  jobs        Job[]
  supplier    Supplier?
  authTokens  AuthToken[]
  sentMessages      Message[] @relation("MessageSender")
  conversations     ConversationParticipant[]
  payments    Payment[]
  reminders   Reminder[]

  @@index([email])
  @@map("users")
}

model AuthToken {
  id         String   @id @default(uuid())
  userId     String
  token      String   @unique
  provider   AuthProvider @default(EMAIL)
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("auth_tokens")
}

model Vehicle {
  id               String      @id @default(uuid())
  userId           String
  make             String
  model            String
  year             Int
  registrationNumber String    @unique
  vin              String?
  type             VehicleType
  fuelType         FuelType
  mileage          Int?
  color            String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  // Relations
  user             User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobs             Job[]

  @@index([userId])
  @@index([registrationNumber])
  @@map("vehicles")
}

model Job {
  id            String      @id @default(uuid())
  userId        String
  vehicleId     String
  type          JobType
  status        JobStatus   @default(PENDING)
  description   String
  priority      String?
  location      String?
  scheduledDate DateTime?
  completedDate DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle       Vehicle     @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  quotes        Quote[]
  payments      Payment[]
  conversations Conversation[]

  @@index([userId])
  @@index([vehicleId])
  @@index([status])
  @@map("jobs")
}

model Supplier {
  id           String        @id @default(uuid())
  userId       String        @unique
  businessName String
  type         SupplierType
  address      String
  city         String
  postcode     String
  phone        String
  email        String
  rating       Float?        @default(0)
  reviewCount  Int           @default(0)
  specialties  String[]
  isVerified   Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  quotes       Quote[]

  @@index([userId])
  @@index([city])
  @@map("suppliers")
}

model Quote {
  id          String      @id @default(uuid())
  jobId       String
  supplierId  String
  status      QuoteStatus @default(PENDING)
  totalAmount Float
  laborHours  Float?
  laborRate   Float?
  notes       String?
  validUntil  DateTime
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  job         Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  supplier    Supplier    @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  items       QuoteItem[]
  payments    Payment[]
  conversations Conversation[]

  @@index([jobId])
  @@index([supplierId])
  @@index([status])
  @@map("quotes")
}

model QuoteItem {
  id          String   @id @default(uuid())
  quoteId     String
  description String
  quantity    Int
  unitPrice   Float
  total       Float
  createdAt   DateTime @default(now())

  // Relations
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@map("quote_items")
}

model Conversation {
  id            String   @id @default(uuid())
  jobId         String?
  quoteId       String?
  lastMessageAt DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  job           Job?     @relation(fields: [jobId], references: [id], onDelete: Cascade)
  quote         Quote?   @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  participants  ConversationParticipant[]
  messages      Message[]

  @@index([jobId])
  @@index([quoteId])
  @@map("conversations")
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  conversationId String
  userId         String
  joinedAt       DateTime     @default(now())

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
  @@map("conversation_participants")
}

model Message {
  id             String      @id @default(uuid())
  conversationId String
  senderId       String
  type           MessageType @default(TEXT)
  content        String
  attachments    String[]
  readAt         DateTime?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@map("messages")
}

model Payment {
  id            String        @id @default(uuid())
  userId        String
  jobId         String?
  quoteId       String?
  amount        Float
  currency      String        @default("GBP")
  status        PaymentStatus @default(PENDING)
  method        PaymentMethod
  transactionId String?
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  job           Job?          @relation(fields: [jobId], references: [id], onDelete: SetNull)
  quote         Quote?        @relation(fields: [quoteId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([jobId])
  @@index([quoteId])
  @@index([status])
  @@index([transactionId])
  @@map("payments")
}

// ============================================
// REMINDERS MODULE
// ============================================

enum ReminderType {
  MOT
  SERVICE
  TAX
  INSURANCE
  CUSTOM
}

enum ReminderStatus {
  PENDING
  SENT
  COMPLETED
  CANCELLED
}

model Reminder {
  id          String         @id @default(uuid())
  userId      String
  vehicleId   String?
  type        ReminderType
  status      ReminderStatus @default(PENDING)
  title       String
  description String?
  dueDate     DateTime
  sentAt      DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([dueDate])
  @@index([status])
  @@map("reminders")
}

// ============================================
// VIDEO CALLING MODULE
// ============================================

enum VideoCallProvider {
  TWILIO
  ZOOM
  TEAMS
  GOOGLE_MEET
}

enum VideoCallStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model VideoCallSession {
  id           String            @id @default(uuid())
  jobId        String?
  provider     VideoCallProvider
  status       VideoCallStatus   @default(SCHEDULED)
  roomId       String
  startTime    DateTime?
  endTime      DateTime?
  duration     Int? // in seconds
  recordingUrl String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@index([jobId])
  @@index([status])
  @@map("video_call_sessions")
}

// ============================================
// LIVE TRACKING MODULE
// ============================================

enum TrackingStatus {
  CHECKING_IN
  DIAGNOSIS
  PARTS_ORDERED
  IN_PROGRESS
  QUALITY_CHECK
  COMPLETED
}

model ServiceLiveTracking {
  id            String         @id @default(uuid())
  jobId         String         @unique
  status        TrackingStatus @default(CHECKING_IN)
  currentStep   String
  estimatedTime Int? // minutes
  technicianId  String?
  photos        String[] // URLs
  videos        String[] // URLs
  notes         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([jobId])
  @@index([status])
  @@map("service_live_tracking")
}

// ============================================
// MARKETING MODULE
// ============================================

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  LOST
}

enum LeadSource {
  WEBSITE
  REFERRAL
  SOCIAL_MEDIA
  ADVERTISING
  OTHER
}

enum CallOutcome {
  NO_ANSWER
  VOICEMAIL
  SCHEDULED
  NOT_INTERESTED
  CONVERTED
}

model Lead {
  id          String     @id @default(uuid())
  firstName   String
  lastName    String
  email       String?
  phone       String
  status      LeadStatus @default(NEW)
  source      LeadSource
  notes       String?
  assignedTo  String?
  convertedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  calls Call[]

  @@index([status])
  @@index([source])
  @@index([assignedTo])
  @@map("leads")
}

model Call {
  id           String       @id @default(uuid())
  leadId       String
  userId       String // caller
  outcome      CallOutcome?
  duration     Int? // seconds
  notes        String?
  scheduledFor DateTime?
  calledAt     DateTime     @default(now())
  createdAt    DateTime     @default(now())

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([userId])
  @@index([calledAt])
  @@map("calls")
}

enum PostPlatform {
  FACEBOOK
  INSTAGRAM
  TWITTER
  LINKEDIN
}

enum PostStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  FAILED
}

model SocialPost {
  id           String       @id @default(uuid())
  platform     PostPlatform
  status       PostStatus   @default(DRAFT)
  content      String
  mediaUrls    String[]
  scheduledFor DateTime?
  publishedAt  DateTime?
  likes        Int          @default(0)
  shares       Int          @default(0)
  comments     Int          @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([platform])
  @@index([status])
  @@index([publishedAt])
  @@map("social_posts")
}

model MarketingSettings {
  id                String   @id @default(uuid())
  autoPostEnabled   Boolean  @default(false)
  postFrequency     Int      @default(3) // posts per week
  targetAudience    String?
  hashtags          String[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("marketing_settings")
}